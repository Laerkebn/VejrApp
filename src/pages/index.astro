---
import "../styles/global.css";
import Svg from "./svg.astro";
---

<html lang="da">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vejr App</title>
  </head>

  <body class="font-philosopher m-0 p-5 bg-gray-200 flex flex-col items-center">
   
    <div class="weather-search mb-5 flex gap-2.5 justify-center max-w-[600px] w-full">
      <input
        id="cityInput"
        type="text"
        placeholder="Søg efter by i Danmark..."
        class="flex-1 px-5 py-3 border-2 border-gray-500 rounded-lg text-base bg-white focus:outline-none focus:border-[#4e93a6]"
      />
      <button
        id="searchBtn"
        class="px-7 py-3 bg-[#4e93a6] text-white border-none font-bold rounded-lg hover:bg-[#3d7a89] cursor-pointer"
      >
        Søg
      </button>
    </div>

    <div id="weatherInfo" class="mb-5 text-center text-gray-800"></div>

    <div
      class="weather-container relative w-full max-w-[600px] aspect-[469.32/307.41] transition-colors duration-1000"
      style="background: var(--bg-color, #87CEEB)"
    >
      <!-- HER er mine SVG’er -->
      <Svg />
    </div>

    <!-- Client-side script -->
    <script type="module" client:load>
      // Tidsbaseret baggrund
      function updateBackgroundByTime() {
        const now = new Date();
        const hour = now.getHours() + now.getMinutes() / 60;

        const timeColors = [
          { hour: 0, color: [10, 20, 40] },
          { hour: 5, color: [25, 35, 60] },
          { hour: 6, color: [255, 140, 100] },
          { hour: 7, color: [109, 174, 207] },
          { hour: 8, color: [160, 210, 240] },
          { hour: 12, color: [135, 206, 235] },
          { hour: 16, color: [140, 200, 230] },
          { hour: 18, color: [255, 150, 100] },
          { hour: 19, color: [72, 82, 163] },
          { hour: 20, color: [80, 60, 100] },
          { hour: 21, color: [40, 40, 70] },
          { hour: 24, color: [10, 20, 40] },
        ];

        let before = timeColors[0];
        let after = timeColors[timeColors.length - 1];

        for (let i = 0; i < timeColors.length - 1; i++) {
          if (hour >= timeColors[i].hour && hour <= timeColors[i + 1].hour) {
            before = timeColors[i];
            after = timeColors[i + 1];
            break;
          }
        }

        const progress = (hour - before.hour) / (after.hour - before.hour);
        const r = Math.round(before.color[0] * (1 - progress) + after.color[0] * progress);
        const g = Math.round(before.color[1] * (1 - progress) + after.color[1] * progress);
        const b = Math.round(before.color[2] * (1 - progress) + after.color[2] * progress);

        document.documentElement.style.setProperty("--bg-color", `rgb(${r}, ${g}, ${b})`);
      }

      updateBackgroundByTime();
      setInterval(updateBackgroundByTime, 60 * 1000);

      // Vejr API funktion
      async function getWeather(city) {
        const API_KEY = "ea4457bca726d0664234f97788706bf3";
        const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric&lang=da&appid=${API_KEY}`;

        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error("By ikke fundet");
          const data = await res.json();
          updateWeatherUI(data);
          console.log("Vejrdata hentet:", data);
        } catch (err) {
          document.getElementById("weatherInfo").innerHTML =
            '<p class="text-red-600">Kunne ikke hente vejret. Tjek by-navn eller API-nøgle.</p>';
          console.error(err);
        }
      }

   
      function updateWeatherUI(data) {
  // Fjernet condition og description variabler
  const weatherId = data.weather[0].id;
  const temp = Math.round(data.main.temp);

  document.getElementById("weatherInfo").innerHTML =
    `<h3 class="text-2xl text-[#4e93a6] font-bold">${data.name} – ${temp}°C</h3>
     <p class="text-gray-600 mt-1">${data.weather[0].description}</p>`;

  // Opdateret console.log til at vise Weather ID
  console.log("Weather ID:", weatherId);

  // Skjul alle vejr-lag først
  document.querySelectorAll(".weather-layer").forEach((el) => {
    el.classList.remove("visible");
  });

  // Vis lag baseret på vejrforhold
  if (weatherId === 800) {
    // Clear sky
    document.getElementById("Højsol")?.classList.add("visible");
  }
  else if (weatherId >= 801 && weatherId <= 804) {
    // 803 = broken clouds, 804 = overcast clouds
    if (weatherId === 803 || weatherId === 804) {
      document.getElementById("graasky")?.classList.add("visible");
      document.getElementById("lillessky")?.classList.add("visible");
    } 
    // 801 = few clouds, 802 = scattered clouds
    else if (weatherId === 801 || weatherId === 802) {
      document.getElementById("solbagsky")?.classList.add("visible");
      document.getElementById("hvidsky")?.classList.add("visible");
    }
  }
  // 200-232 = Thunderstorm
  else if (weatherId >= 200 && weatherId <= 232) {
    document.getElementById("storskygge")?.classList.add("visible");
    document.getElementById("lyn")?.classList.add("visible");
    document.getElementById("lillessky")?.classList.add("visible");
    document.getElementById("regn")?.classList.add("visible");
  }
  // 300-531 = Drizzle and Rain
  else if (weatherId >= 300 && weatherId <= 531) {
    document.getElementById("storskygge")?.classList.add("visible");
    document.getElementById("regn")?.classList.add("visible");
  }
  // 600-622 = Snow
  else if (weatherId >= 600 && weatherId <= 622) {
    document.getElementById("hvidsky")?.classList.add("visible");
    document.getElementById("sne")?.classList.add("visible");
  }

  //  vind-tjek
  if (data.wind && data.wind.speed > 10) {
    document.getElementById("vind")?.classList.add("visible");
  }
}


      // Søgning ved klik
      document.getElementById("searchBtn")?.addEventListener("click", () => {
        const city = document.getElementById("cityInput").value.trim();
        if (city) getWeather(city);
        else alert("Indtast venligst en by");
      });

      // Søgning ved Enter-tast
      document.getElementById("cityInput")?.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          const city = document.getElementById("cityInput").value.trim();
          if (city) getWeather(city);
        }
      });

      // Start med København som standardby
      getWeather("Copenhagen");
    </script>
  </body>
</html>